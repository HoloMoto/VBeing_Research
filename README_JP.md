# Pneuma (Personal Nurturing Entity for User Maid Assistance)

[English Version (英語版)](README.md)

Pneuma は、Google の Gemini AI を使用して、`voiceData.csv` のデータに基づいて `Voice/` ディレクトリから音声ファイルを再生するパーソナルアシスタントプロジェクトです。

このプロジェクトは開発中であることに留意ください。

## 概要

このスクリプトは、以下の10の動作モードを提供します：

1. **ダイレクトモード**：Gemini が入力プロンプトに基づいて直接音声ファイルを選択します
2. **テキストマッチングモード**：Gemini の応答と音声データのテキストをマッチングします
3. **手動選択モード**：番号で音声ファイルを直接選択します
4. **利用可能なモデル一覧**：トラブルシューティング用に利用可能な Gemini モデルを表示します
5. **音声認識モード**：タイピングの代わりにマイク入力を使用します
6. **テキストのみモード**：音声再生なしで Gemini と対話します
7. **RAG モード**：会話には Gemini を使用し、音声選択にはローカル RAG を使用します（トークン効率が良い）
8. **音声 RAG モード**：音声入力と Gemini による会話、および音声のローカル RAG を使用します（トークン効率が良い）
9. **Zonos 音声生成モード**：Zyphra API を使用して各応答に新しい音声を生成します
10. **PC制御モード**：音声コマンドを使用してPCを制御します（プログラムの実行、ファイル管理など）

Gemini とのすべての会話は自動的に `Log.txt` ファイルに記録され、後で参照できます。

## 必要条件

- Python 3.7+
- pygame ライブラリ（音声再生用）
- speech_recognition ライブラリ（音声認識用）
- pyaudio ライブラリ（マイクアクセス用）
- python-dotenv ライブラリ（環境変数読み込み用）
- システムにインストールおよび設定された Gemini CLI

## セットアップ

1. システムに Gemini CLI をインストールします
   - [公式 Gemini CLI インストール手順](https://cloud.google.com/gemini/docs/codeassist/gemini-cli)に従ってください
   - このスクリプトを実行する前に CLI で認証を済ませてください
2. プロジェクトのルートディレクトリに `.env` ファイルを作成し、以下の内容を追加します：
   ```
   GEMINI_API_KEY=your_gemini_api_key_here
   PORT=5000
   GEMINI_CLI_PATH=path_to_your_gemini_cli
   SYSTEM_PROMPT_PATH=system_prompt.txt
   ZONOS_API=your_zonos_api_key_here
   ```
   - `your_gemini_api_key_here` を実際の Gemini API キーに置き換えてください
   - `path_to_your_gemini_cli` を Gemini CLI へのパスに置き換えてください（例：`C:/Users/username/AppData/Roaming/npm/gemini.cmd`）
   - モード9を使用する予定がある場合は、`your_zonos_api_key_here` を実際の Zonos API キーに置き換えてください
3. （オプション）カスタムシステムプロンプトを設定します：
   - `system_prompt.txt` ファイルを編集してカスタムシステムプロンプトの指示を追加します
4. 必要な Python パッケージをインストールします：
   ```
   pip install -r requirements.txt
   ```
   または個別にパッケージをインストールします：
   ```
   pip install pygame SpeechRecognition pyaudio python-dotenv flask
   ```
5. `.env` ファイルを安全に保ち、バージョン管理にコミットしないようにしてください
   - プロジェクトの `.gitignore` ファイルは既に機密ファイルを除外するように設定されています

## 使用方法

### コマンドラインインターフェース

1. スクリプトを実行します：
   ```
   python play_voice_with_gemini.py
   ```
2. 最初にモード（1, 2, 3, 4, 5, 6, 7, または 8）を選択します
3. 連続したチャットセッションで Gemini との会話を続けます
4. 終了するには「quit」と入力または発話し、モードを変更するには「change mode」と入力または発話します
5. すべての会話は自動的に同じディレクトリの `Log.txt` に記録されます

### Webインターフェース（新機能！）

Webベースのグラフィカルユーザーインターフェースが利用可能になりました：

1. Flaskをインストールします：
   ```
   pip install flask
   ```
2. Webインターフェースを実行します：
   ```
   python web_interface.py
   ```
3. ブラウザを開いて `http://localhost:5000` にアクセスします
4. モードを選択して、Webインターフェースを通じて Gemini と対話を開始します

Webインターフェースの詳細な使用方法については、[README_WEB.md](README_WEB.md)を参照してください。

### モード 1：ダイレクト選択

このモードでは、Gemini にプロンプトを提供すると、利用可能なファイルに基づいて再生する音声ファイルを直接選択します。会話履歴が維持されるため、Gemini は以前のやり取りを記憶し、より文脈に沿った応答が可能です。

### モード 2：テキストマッチング

このモードでは、Gemini にプロンプトを提供すると、スクリプトは Gemini の応答と `voiceData.csv` のテキストをマッチングして、最も適切な音声ファイルを再生します。会話履歴が維持されるため、より自然で文脈に沿ったやり取りが可能です。

### モード 3：手動選択

このモードでは、番号付きリストから再生する音声ファイルを直接選択できます。モード選択メニューに戻ることなく、ファイルの選択を続けることができます。

### モード 4：利用可能なモデル一覧

このモードでは、API キーで使用できるすべての Gemini モデルを表示します。モデル関連のエラーが発生した場合や、アクセス可能なモデルを確認したい場合のトラブルシューティングに役立ちます。

### モード 5：音声認識

このモードでは、タイピングの代わりにマイクに向かって話すことができます。スクリプトは音声をキャプチャし、Google の音声認識サービスを使用してテキストに変換し、モード 2（テキストマッチング）と同様に Gemini で処理します。これにより、より自然なハンズフリーでの対話が可能になります。デフォルト言語は日本語（ja-JP）に設定されていますが、必要に応じてコードで変更できます。

### モード 6：テキストのみ

このモードでは、音声再生なしでテキストのみを通じて Gemini と対話します。Gemini との一般的な会話や、音声応答が不要な場合に便利です。このモードでのすべての会話は、後で参照できるように `Log.txt` ファイルに記録されます。

### モード 7：RAG モード

このモードでは、スクリプトは会話応答の生成にのみ Gemini を使用し、音声選択にはローカルテキストマッチング（検索拡張生成、RAG）を使用します。Gemini に直接音声ファイルを選択させないため、モード 1 やモード 2 と比較してトークン使用量が大幅に削減されます。会話履歴は文脈に沿った応答のために維持され、ローカル RAG アルゴリズムは Gemini の応答に基づいて最も適切な音声ファイルを選択します。

### モード 8：音声 RAG モード

このモードは、モード 7 のトークン効率とモード 5 の音声認識の利便性を組み合わせています。マイクに向かって話すと、スクリプトは音声をテキストに変換し、Gemini を使用して応答を生成し、ローカル RAG を使用して最も適切な音声ファイルを選択します。これにより、API トークン使用量を最小限に抑えながら、完全に音声対話型の体験を提供します。

## 会話ログ

Gemini とのすべてのやり取りは、スクリプトと同じディレクトリの `Log.txt` ファイルに自動的に記録されます。各ログエントリには以下が含まれます：

- 会話のタイムスタンプ
- 対話に使用されたモード
- ユーザーの入力プロンプト
- Gemini の応答
- 再生された音声ファイル（該当する場合）

このログ機能により、過去の会話を確認し、Gemini の応答を時間の経過とともに追跡し、すべてのやり取りの記録を維持することができます。ログファイルは存在しない場合は自動的に作成され、新しいエントリはファイルの末尾に追加されます。

## パフォーマンス最適化

このスクリプトには、応答時間の短縮、トークン消費量の削減、精度向上のための多数の最適化が含まれています：

1. **モデル初期化**：モデルはリクエストごとではなく、起動時に一度だけ初期化されます
2. **会話履歴**：スクリプトは以前のやり取りをプロンプトに含めることで会話履歴を維持し、より文脈に沿った一貫性のある会話を実現します
3. **連続チャット**：モードは一度だけ選択すれば、中断することなくチャットを続けることができます
4. **効率的なプロンプト管理**：文脈を維持しながらトークン使用量を最小限に抑える超簡潔なプロンプト形式を使用します
5. **ローカルファイルアクセス**：音声データを保存するローカル JSON ファイルを使用し、Gemini が各プロンプトにすべての音声データを含める代わりに直接ファイルを読み取ることができるようにして、応答時間を大幅に短縮します
6. **トークン効率の良いモード**：RAG モード（7 と 8）は会話にのみ Gemini を使用し、音声選択はローカルで処理することで、トークン使用量を劇的に削減します
7. **最適化されたエラー処理**：クォータエラーの場合、再試行せずに即座に次のモデルを試すことでトークンを節約します
8. **モデル優先順位付け**：デフォルトモデルとして gemini-2.5-pro よりもクォータ制限が高い gemini-2.5-flash を使用します

### 強化されたキャッシングとパフォーマンス
9. **LRU キャッシングシステム**：音声選択、N-gram 計算、文字類似性、複雑性分析に最近使用されたもの（LRU）キャッシングを実装し、応答速度を劇的に向上させます
10. **マルチレベルキャッシング**：適切なキャッシュサイズと削除ポリシーを持つ異なるコンポーネント用の特殊なキャッシングを使用します
11. **最適化された N-gram 計算**：長いテキストの始め、四分点、中間、終わりから戦略的にサンプリングする強化アルゴリズムにより、計算量を削減しながら精度を向上させます
12. **動的並列処理**：CPU コアとワークロードサイズに基づいて自動的にスレッド数を調整し、重要なパスに優先度ベースのタスクスケジューリングを行います

### 日本語処理の改善
13. **包括的な日本語パターンマッチング**：様々な会話機能（質問、同意、否定、挨拶など）をカバーする 10 以上のカテゴリと 150 以上のパターンを持つ拡張パターン認識
14. **文脈を考慮した類似性計算**：感情的なトーンマッチング、フォーマリティマッチング、会話フロー分析、トピック一貫性などの洗練された指標を使用します
15. **高度な文字レベルの埋め込み**：文字タイプ（漢字、ひらがな、カタカナ、句読点）と位置による重み付けを持つ頻度ベースの文字分析
16. **日本語助詞の最適化**：マッチング精度を向上させるための日本語助詞と文構造の特別な処理

### インテリジェントなリソース管理
17. **動的会話履歴**：会話の複雑さと文脈参照に基づいて履歴の長さと詳細を自動的に調整します
18. **洗練されたモデル選択**：7 つの異なる複雑性指標（長さ、質問タイプ、技術的内容、文脈、言語的複雑さ、推論、創造性）を分析して最適なモデルとパラメータを選択します
19. **パラメータ最適化**：会話のニーズに基づいて温度、最大出力トークン、その他のパラメータを動的に調整します
20. **適応処理**：単純な入力には高価な操作をスキップし、必要な場合にのみ完全な処理を適用します

### トークン最適化とモニタリング
21. **強化されたトークン推定**：文字タイプ、パターン、言語特性を考慮した日本語テキスト用の特殊な処理を持つ高精度トークンカウント
22. **包括的なトークン追跡**：リクエスト、モデル、時間帯ごとのトークン使用量の詳細なモニタリングと、推定節約量の計算
23. **動的メッセージ切り捨て**：切り捨てが必要な場合にメッセージの最も重要な部分を知的に保持します
24. **セッション分析**：最適化の機会を特定するのに役立つトークン使用パターンに関する洞察を提供します

これらの最適化が連携して、API トークン消費を最小限に抑えながらパフォーマンスを最大化する、応答性が高く、効率的で正確な体験を提供します。

## ファイル構造

- `play_voice_with_gemini.py`：メインの Python スクリプト
- `voiceData.csv`：音声ファイル名とそのテキスト内容をマッピングする CSV ファイル
- `Voice/`：WAV 音声ファイルを含むディレクトリ
- `Log.txt`：自動生成される会話ログを含むファイル
- `TTS_Log/`：テキスト読み上げログファイルを含むディレクトリ
- `system_prompt.txt`：カスタムシステムプロンプト指示を含むファイル
- `.env`：API キーやパスなどの環境変数用の設定ファイル
- `.gitignore`：バージョン管理から除外するファイルを指定する設定ファイル
- `web_interface.py`：アプリケーションのウェブインターフェーススクリプト
- `templates/`：ウェブインターフェース用の HTML テンプレートを含むディレクトリ
- `static/`：ウェブインターフェース用の静的ファイル（CSS、JavaScript）を含むディレクトリ
- `system_prompt_templates/`：異なるモード用のテンプレートシステムプロンプトを含むディレクトリ

## セキュリティ

このプロジェクトでは、安全に保管すべき API キーやその他の機密情報を使用しています：

- **API キー**：API キーをバージョン管理にコミットしないでください。`.gitignore` ファイルで除外されている `.env` ファイルに保存してください。
- **ログファイル**：会話ログには機密情報が含まれている可能性があります。`Log.txt` ファイルと `TTS_Log/` ディレクトリは `.gitignore` ファイルで除外されています。
- **環境変数**：`.env` ファイルには機密情報が含まれており、共有したりバージョン管理にコミットしたりしないでください。
- **音声データ**：`Voice/` ディレクトリには個人の音声録音が含まれている可能性があり、`.gitignore` ファイルで除外されています。

このリポジトリをフォークまたはクローンする場合は、以下を確認してください：
1. 自分の API キーを含む独自の `.env` ファイルを作成する
2. 機密ファイルが `.gitignore` ファイルで適切に除外されていることを確認する
3. 機密情報が誤ってコミットされていないか定期的にリポジトリを確認する

## トラブルシューティング

- 日本語テキストでエンコーディングの問題が発生した場合、スクリプトは異なるエンコーディング（utf-8, shift-jis, euc-jp, iso-2022-jp）を試します
- Gemini CLI がシステムに正しくインストールおよび設定されていることを確認してください
- .env ファイル内の Gemini CLI へのパスが正しいことを確認してください
- 必要なパッケージがすべてインストールされていることを確認してください
- スクリプトは 'gemini-2.5-flash' モデルを使用し、必要に応じて 'gemini-2.5-pro' と 'gemini-pro-vision' にフォールバックします
- Gemini CLI でエラーが発生した場合：
  1. `gemini auth login` を実行して CLI で認証されていることを確認します
  2. `gemini models list` を実行してモデルが利用可能であることを確認します
  3. CLI 出力のエラーメッセージを確認します
- クォータ制限エラーが発生した場合、スクリプトは：
  1. 再試行せずに即座に次の利用可能なモデルを試します（トークンを節約するため）
  2. クォータ制限に関する明確なエラーメッセージを提供します
  3. API 使用量を最小限に抑えるためにトークン効率の良いモード（7 と 8）を使用します
- クォータ制限に頻繁に達する場合は、以下を検討してください：
  1. リクエストの間隔を空ける
  2. より高いクォータを持つ有料 API ティアにアップグレードする
