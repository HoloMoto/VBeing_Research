# VBeing_Research システムアーキテクチャ

## 概要

このドキュメントは、Gemini AIモデルと音声再生機能を統合して「プネウマ」という名前のインタラクティブなAIアシスタントを作成するVBeing_Researchシステムアーキテクチャの包括的な概要を提供します。

## システムコンポーネント

システムは以下の主要コンポーネントで構成されています：

1. **Webインターフェース** (`web_interface.py`)
   - Flaskベースのウェブアプリケーション
   - インタラクション用のユーザーインターフェースを提供
   - 会話履歴を管理
   - APIリクエストを処理

2. **コア処理エンジン** (`play_voice_with_gemini.py`)
   - Gemini CLIとのインターフェース
   - ユーザー入力を処理
   - 音声選択と再生を管理
   - 会話コンテキストを処理

3. **音声データ管理**
   - 音声ファイルは `Voice/` ディレクトリに保存
   - 音声メタデータは `voiceData.csv` に保存
   - クローン音声は `Voice/CloneVoice/` ディレクトリに保存

4. **外部サービス**
   - Gemini API（CLI経由）
   - Zonos API（音声生成用）
   - 音声認識サービス

5. **設定**
   - システムプロンプト（`system_prompt.txt`）
   - 環境変数（`.env`）
   - システムプロンプトテンプレート（`system_prompt_templates/`）

## システムアーキテクチャ図

```
+----------------------------------+
|        User's Web Browser        |
+------------------+---------------+
                   |
                   v
+----------------------------------+
|      Web Interface (Flask)       |
|        web_interface.py          |
+------------------+---------------+
                   |
                   v
+----------------------------------+
|    Core Processing Engine        |
|    play_voice_with_gemini.py     |
+-+----------------+---------------+
  |                |
  v                v
+--------+    +-------------------+
| Voice  |    |  External APIs    |
| Data   |    |                   |
+--------+    | +---------------+ |
| .wav   |    | | Gemini CLI    | |
| .webm  |<-->| +---------------+ |
| files  |    | | Zonos API     | |
|        |    | +---------------+ |
| CSV    |    | | Speech        | |
| data   |    | | Recognition   | |
+--------+    | +---------------+ |
              +-------------------+
```

## データフロー

1. **ユーザー入力フロー**
   - ユーザーがWebインターフェースにテキストを入力するか、話しかける
   - WebインターフェースがリクエストをFlaskバックエンドに送信
   - Flaskバックエンドがリクエストを処理し、コアエンジンの適切な関数を呼び出す
   - コアエンジンがGemini APIを使用して応答を生成
   - 応答がWebインターフェースに送り返され、ユーザーに表示される

2. **音声応答フロー**
   - 選択されたモードに基づいて、システムは以下のいずれかを実行：
     - 既存の音声データから適切な音声ファイルを選択（モード1、2、5、7、8）
     - Zonos APIを使用して新しい音声を生成（モード9）
   - 音声はWebインターフェースを通じて再生される
   - 音声ファイルとメタデータは将来の使用のために保存される

3. **設定フロー**
   - システムプロンプトがGeminiの応答を導く
   - 環境変数がAPI接続を設定
   - システムプロンプトテンプレートがモード固有の指示を提供

## 操作モード

システムは複数の操作モードをサポートしています：

1. **ダイレクトモード（1）**：Geminiが直接音声ファイルを選択
2. **テキストマッチングモード（2）**：Geminiの応答と音声データのテキストをマッチング
3. **手動選択モード（3）**：番号で音声ファイルを選択
4. **利用可能なモデルの一覧表示（4）**：利用可能なすべてのGeminiモデルを表示
5. **音声認識モード（5）**：タイピングの代わりにマイク入力を使用
6. **テキストのみモード（6）**：音声再生なしでGeminiと対話
7. **RAGモード（7）**：会話にはGeminiを使用し、音声選択にはローカルRAGを使用（トークン効率的）
8. **音声RAGモード（8）**：会話には音声入力とGeminiを使用し、音声選択にはローカルRAGを使用（トークン効率的）
9. **Zonos音声生成モード（9）**：Zonos APIを使用して音声応答を生成

## エラー処理と回復力

システムには、エラー処理と回復力のためのいくつかのメカニズムが含まれています：

1. **クォータ管理**
   - クォータ枯渇を防ぐためにAPI使用量を追跡
   - クォータが超過した場合に代替モデルにフォールバック
   - クォータ制限に関する明確なエラーメッセージを提供

2. **接続リトライ**
   - 一時的なエラーに対する指数バックオフを実装
   - 不要なAPI呼び出しを減らすために接続状態をキャッシュ

3. **応答フィルタリング**
   - ログエントリや一般的な確認応答を検出してフィルタリング
   - ユーザークエリに対する意味のある応答を確保

## セキュリティ考慮事項

1. **API認証**
   - Gemini CLIはシステム認証を使用
   - Zonos APIキーは環境変数に保存

2. **データストレージ**
   - 音声データはローカルに保存
   - 会話ログは `Log.txt` に保存

## 将来の拡張

将来の拡張の可能性がある領域：

1. 音声クローニング機能の改善
2. より文脈に沿った応答のためのRAG実装の強化
3. 多言語サポート
4. 追加のAIモデルと音声サービスとの統合